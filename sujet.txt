/opt/lampp/bin/php -S localhost:8001 -t public

CREATE DATABASE poste;
USE poste;

CREATE TABLE poste_zone_livraison (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(150) NOT NULL
);

CREATE TABLE poste_adresse (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(150) NOT NULL,
    id_zone INT NOT NULL,
    FOREIGN KEY (id_zone) REFERENCES poste_zone_livraison(id)
);

CREATE TABLE poste_vehicule (
    id INT AUTO_INCREMENT PRIMARY KEY,
    immatriculation VARCHAR(50) NOT NULL UNIQUE,
    marque VARCHAR(50) NOT NULL,
    cout_journalier DECIMAL(10,2) NOT NULL CHECK (cout_journalier >= 0),
    estActif BOOLEAN DEFAULT TRUE
);

CREATE TABLE poste_livreur (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(100) NOT NULL,
    salaire_journalier DECIMAL(10,2) NOT NULL CHECK (salaire_journalier >= 0)
);

CREATE TABLE poste_colis (
    id INT AUTO_INCREMENT PRIMARY KEY,
    poids DECIMAL(5,2) NOT NULL CHECK (poids > 0),
    prix_kg DECIMAL(10,2) NOT NULL CHECK (prix_kg >= 0)
);

CREATE TABLE poste_entrepot (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(150) NOT NULL,
    id_adresse INT NOT NULL,
    FOREIGN KEY (id_adresse) REFERENCES poste_adresse(id)
);

CREATE TABLE poste_livraison (
    id INT AUTO_INCREMENT PRIMARY KEY,
    id_livreur INT NOT NULL,
    id_vehicule INT NOT NULL,
    id_colis INT NOT NULL,
    id_adresse INT NOT NULL,
    id_entrepot INT NOT NULL,
    date_livraison DATE NOT NULL,
    montantRecette DECIMAL(10,2) DEFAULT 0.00,
    statut ENUM('en attente', 'livre', 'annule') NOT NULL DEFAULT 'en attente',
    FOREIGN KEY (id_livreur) REFERENCES poste_livreur(id),
    FOREIGN KEY (id_vehicule) REFERENCES poste_vehicule(id),
    FOREIGN KEY (id_colis) REFERENCES poste_colis(id),
    FOREIGN KEY (id_adresse) REFERENCES poste_adresse(id),
    FOREIGN KEY (id_entrepot) REFERENCES poste_entrepot(id),
    INDEX idx_date_livreur (date_livraison, id_livreur)
);

DROP VIEW IF EXISTS vue_benefices;
CREATE VIEW vue_benefices AS
SELECT
    l.date_livraison,
    COUNT(DISTINCT l.id_livreur) AS nb_livreurs,
    COUNT(DISTINCT l.id_vehicule) AS nb_vehicules_actifs,
    SUM(c.poids * c.prix_kg) AS total_recette_colis,
    
    -- Coût total des livreurs (1 salaire par livreur par jour)
    SUM(DISTINCT li.salaire_journalier) AS total_salaires_livreurs,
    
    -- Coût total des véhicules (1 coût journalier par véhicule utilisé dans la journée)
    SUM(DISTINCT v.cout_journalier) AS total_couts_vehicules_carburant,
    
    -- Bénéfice net du jour
    (SUM(c.poids * c.prix_kg) 
     - SUM(DISTINCT li.salaire_journalier) 
     - SUM(DISTINCT v.cout_journalier)
    ) AS benefice_journalier

FROM poste_livraison l
JOIN poste_colis c ON l.id_colis = c.id
JOIN poste_livreur li ON l.id_livreur = li.id
JOIN poste_vehicule v ON l.id_vehicule = v.id
WHERE l.statut = 'livre'
  AND v.estActif = TRUE  -- optionnel : ignorer les véhicules désactivés
GROUP BY l.date_livraison
ORDER BY l.date_livraison DESC;



 select * from poste_colis;
+----+-------+---------+---------+
| id | poids | prix_kg | libelle |
+----+-------+---------+---------+
|  1 |  5.00 | 3000.00 |         |
|  2 | 10.00 | 2500.00 |         |
|  3 | 25.00 | 3000.00 | Fruits  |
|  4 | 50.00 | 5000.00 | Ciment  |
+----+-------+---------+---------+
voici ceux qu'il y a dans ma table
CREATE TABLE poste_livreur (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(100) NOT NULL,
    salaire_journalier DECIMAL(10,2) NOT NULL CHECK (salaire_journalier >= 0)--salaire par livraison
);

ALTER TABLE poste_colis 
ADD COLUMN libelle VARCHAR(100) NOT NULL;
mais genre moi je veux que il y a une utilisateur il entre son colis il entre son libelle et combien de kilos fait sont colis et genre il doit choisir le genre de colis par exemple aliment perimable, textile parce que chaque genre a donc sont prix par kilo et c'est à partir du genre que l'utilisateur à mis qu'il calcul le prix total de cette colis mais la ma table manque déjà et je ne sais pas si on a besoin de 2 tables pour ça

